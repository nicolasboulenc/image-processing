<!doctype html>
<html lang="en-US">
<head>
	<meta charset="utf-8" />
	<title>SVG Demo</title>
	<meta name="viewport" content="width=device-width" />
	<style>
		body {
			background-color: blue;
		}
		svg {
			background-color: #222;
			margin-top: 100px;
		}

		circle {
			fill: white;
		}
		.node-contents {
			fill: #aaa;
		}

		.handle {
			fill: lightgoldenrodyellow;
		}

		.node text {
			font: 19px sans-serif;
			fill: black;
		}

	</style>
</head>
<body>
<svg viewBox="0 0 500 500" width="500" height="500" xmlns="http://www.w3.org/2000/svg">

	<rect x="100" y="100" width="100" height="100" class="draggable anchor" />

	<g class="draggable node">
		<rect x="300" y="200" width="150" height="70" class="handle" />
		<text x="302" y="217" class="handle">Node 1</text>
		<rect x="300" y="220" width="150" height="70" class="node-contents" />
	</g>

	<g class="draggable">
		<circle cx="300" cy="300" r="70" class="anchor"/>
	</g>

</svg>
<script>

	let draggable = null

	document.addEventListener("mousedown", draggable_mousedown)
	document.addEventListener("mouseup", draggable_mouseup)
	document.addEventListener("mousemove", draggable_mousemove)

	document.addEventListener("mousedown", linkable_mousedown)
	document.addEventListener("mouseup", linkable_mouseup)
	document.addEventListener("mousemove", linkable_mousemove)

	create_node()



	function draggable_mousedown(evt) {

		console.log("linkable_mousedown")

		if(evt.target.classList.contains("handle")) {
			draggable = evt.target.parentElement
			while(draggable !== null && draggable.classList.contains("draggable") !== true) {
				draggable = draggable.parentElement
			}
		}
		else if(evt.target.classList.contains("draggable")) {
			draggable = evt.target
		}

		if(draggable !== null) {
			const cbox = draggable.getBoundingClientRect()

			offset_x = cbox.x - evt.clientX
			offset_y = cbox.y - evt.clientY

			const sbox = draggable.getBBox()

			const state = { is_dragging: true, origin: {x: sbox.x, y: sbox.y}, offset: {x: offset_x, y: offset_y} }
			draggable.dataset["state"] = JSON.stringify(state)

			if(draggable.transform.baseVal.length === 0) {
				const transform = document.querySelector("svg").createSVGTransform()
				draggable.transform.baseVal.appendItem(transform)
			}
			// svg equivalent to z-index
			document.querySelector("svg").appendChild(draggable)
		}
	}


	function draggable_mouseup(evt) {

		if(draggable !== null) {
			delete draggable.dataset["state"]
			draggable = null
		}
	}


	function draggable_mousemove(evt) {

		if(draggable !== null) {

			const data = draggable.dataset.state
			if(typeof data === "undefined") return

			const state = JSON.parse(data)
			const pbox = draggable.ownerSVGElement.getBoundingClientRect()
			const x = evt.clientX - pbox.x + state.offset.x - state.origin.x
			const y = evt.clientY - pbox.y + state.offset.y - state.origin.y

			draggable.transform.baseVal[0].setTranslate(x, y)
		}
	}


	function linkable_mousedown(evt) {
		if(evt.target.classList.contains("anchor")) {
			console.log("linkable_mousedown")
		}
		return true
	}


	function linkable_mouseup(evt) {
		
	}


	function linkable_mousemove(evt) {
		
	}


	function create_node(x=50, y=250) {
		
		const NODE_WIDTH = 150
		const svg = document.querySelector("svg")

		const text = `
			<rect x="0" y="0" width="${NODE_WIDTH}" height="70" class="handle" />
			<text x="2" y="17" width="${NODE_WIDTH}" class="handle title">Node 2</text>
			<rect x="0" y="20" width="${NODE_WIDTH}" height="70" class="node-contents" />`

		const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
		g.classList.add("draggable")
		g.classList.add("node")
		g.innerHTML = text

		const transform = svg.createSVGTransform()
		transform.setTranslate(x, y)
		g.transform.baseVal.appendItem(transform)
		svg.appendChild(g)
	}






</script>
</body>
</html>
