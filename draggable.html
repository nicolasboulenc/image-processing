<!doctype html>
<html lang="en-US">
<head>
	<meta charset="utf-8" />
	<title>SVG Demo</title>
	<meta name="viewport" content="width=device-width" />
	<style>
		body {
			background-color: blue;
		}
		svg {
			background-color: darkgray;
			margin-top: 100px;
		}
		rect {
			fill: black;
		}
		circle {
			fill: white;
		}
		.white {
			fill: white;
		}

		.node > rect {
		}

		.node .title {
			font: 20px sans;
			background-color: black;
		}

	</style>
</head>
<body>
<svg viewBox="0 0 500 500" width="500" height="500" xmlns="http://www.w3.org/2000/svg">

	<rect x="100" y="100" width="100" height="100" class="draggable" />

	<g class="draggable node">
		<rect x="300" y="200" width="150" height="70" class="handle" />
		<text x="300" y="220" class="handle title">RGB Splitter</text>
		<rect x="300" y="220" width="150" height="70" class="white" />
	</g>

	<g class="draggable">
		<circle cx="300" cy="300" r="70" class="handle"/>
	</g>


</svg>
<script>

	document.addEventListener("mousedown", draggable_mousedown)
	document.addEventListener("mouseup", draggable_mouseup)
	document.addEventListener("mousemove", draggable_mousemove)

	create_node()

	// make_draggable(document.getElementById("r1"))
	// make_draggable(document.getElementById("g1"), document.getElementById("r2"))


	function draggable_mousedown(evt) {

		let draggable = null
		if(evt.target.classList.contains("handle")) {
			draggable = evt.target.parentElement
			while(draggable !== null && draggable.classList.contains("draggable") !== true) {
				draggable = draggable.parentElement
			}
		}
		else if(evt.target.classList.contains("draggable")) {
			draggable = evt.target
		}

		if(draggable !== null) {
			const cbox = draggable.getBoundingClientRect()

			offset_x = cbox.x - evt.clientX
			offset_y = cbox.y - evt.clientY

			const sbox = draggable.getBBox()

			const state = { is_dragging: true, origin: {x: sbox.x, y: sbox.y}, offset: {x: offset_x, y: offset_y} }
			draggable.dataset["state"] = JSON.stringify(state)

			if(draggable.transform.baseVal.length === 0) {
				const transform = document.querySelector("svg").createSVGTransform()
				draggable.transform.baseVal.appendItem(transform)
			}
			// svg equivalent to z-index
			document.querySelector("svg").appendChild(draggable)
		}

	}


	function draggable_mouseup(evt) {

		let draggable = null
		if(evt.target.classList.contains("handle")) {
			draggable = evt.target.parentElement
			while(draggable !== null && draggable.classList.contains("draggable") !== true) {
				draggable = draggable.parentElement
			}
		}
		else if(evt.target.classList.contains("draggable")) {
			draggable = evt.target
		}

		if(draggable !== null) {
			delete draggable.dataset["state"]
		}
	}


	function draggable_mousemove(evt) {

		let draggable = null
		if(evt.target.classList.contains("handle")) {
			draggable = evt.target.parentElement
			while(draggable !== null && draggable.classList.contains("draggable") !== true) {
				draggable = draggable.parentElement
			}
		}
		else if(evt.target.classList.contains("draggable")) {
			draggable = evt.target
		}

		if(draggable !== null) {

			const data = draggable.dataset.state
			if(typeof data === "undefined") return

			const state = JSON.parse(data)
			const pbox = evt.target.ownerSVGElement.getBoundingClientRect()
			const x = evt.clientX - pbox.x + state.offset.x - state.origin.x
			const y = evt.clientY - pbox.y + state.offset.y - state.origin.y

			draggable.transform.baseVal[0].setTranslate(x, y)
		}
	}


	function create_node(x=350, y=200) {
		
		const NODE_WIDTH = 150
		const svg = document.querySelector("svg")

		const text = `
			<rect x="0" y="0" width="${NODE_WIDTH}" height="70" class="handle" />
			<text x="0" y="20" width="${NODE_WIDTH}" class="handle title">RGB Splitter</text>
			<rect x="0" y="20" width="${NODE_WIDTH}" height="70" class="white" />
			<input type="checkbox" />`

		
		const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
		g.classList.add("draggable")
		g.innerHTML = text

		const transform = svg.createSVGTransform()
		transform.setTranslate(x, y)
		g.transform.baseVal.appendItem(transform)
		svg.appendChild(g)
	}



	// function make_draggable(elem, handle=null) {

	// 	if(handle === null) {
	// 		elem.classList.add("draggable")
	// 	}
	// 	else {
	// 		handle.classList.add("draggable")
	// 	}

	// 	// to fix: convert view box to client etc
	// 	const bbox = elem.getBBox()
	// 	const state = { is_dragging: false, elem_id: elem.id, origin: {x: bbox.x, y: bbox.y}, offset: {x: 0, y: 0} }
	// 	handle.dataset["state"] = JSON.stringify(state)
	// }


</script>
</body>
</html>
